networks:
  grafana-ascent_ascent:
    external: true
volumes:
  loki_data:

services:
  # 1. L'Application simul√©e
  python-app:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.9-slim
        RUN pip install prometheus_client flask
        COPY app_logger.py .
        CMD ["python", "app_logger.py"]
    container_name: python-app
    ports:
      - "32550:8000"
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
    networks:
      - grafana-ascent_ascent

  # 3. Loki (Stockage des Logs)
  loki:
    image: grafana/loki:3.6.6
    container_name: loki
    ports:
      - "32460:3100"
    command:
      - "-config.file=/etc/loki/local-config.yaml"
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    #healthcheck:
      #test: [ "/bin/sh", "-c", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1" ]
      #interval: 10s
      #timeout: 5s
      #retries: 5
    networks:
      - grafana-ascent_ascent

  # 4. Promtail (Agent de collecte des logs)
  promtail:
    image: grafana/promtail:latest
    user: root
    container_name: promtail
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:Z
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    networks:
      - grafana-ascent_ascent

